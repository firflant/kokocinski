<?php

/**
 * @file
 * Page Analytics module.
 */

declare(strict_types=1);

/**
 * Implements hook_theme().
 */
function page_analytics_theme(array $existing, string $type, string $theme, string $path): array {
  return [
    'page_analytics_report' => [
      'variables' => [
        'rows' => [],
        'period' => 7,
        'period_7_url' => '',
        'period_30_url' => '',
        'top_limit' => 30,
        'top_options' => [],
        'sampling_rate' => 1,
        'sampling_note' => '',
      ],
      'template' => 'page-analytics-report',
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK() for page_analytics_report.
 *
 * Builds top_options in PHP so the array reaches Twig without going through
 * the render-array pass that can drop or alter array variables.
 */
function page_analytics_preprocess_page_analytics_report(array &$variables): void {
  $period = (int) ($variables['period'] ?? 7);
  $top_limit = (int) ($variables['top_limit'] ?? 30);

  $variables['top_options'] = [];
  foreach (\Drupal\page_analytics\Controller\PageAnalyticsReportController::TOP_LIMIT_OPTIONS as $n) {
    $variables['top_options'][] = [
      'value' => $n,
      'url' => \Drupal\Core\Url::fromRoute('page_analytics.report', [], [
        'query' => ['period' => $period, 'top' => $n],
      ])->toString(),
    ];
  }
}

/**
 * Implements hook_cron().
 */
function page_analytics_cron(): void {
  $retention_days = (int) \Drupal::config('page_analytics.settings')->get('retention_days');
  if ($retention_days < 1) {
    $retention_days = 365;
  }
  $cutoff = date('Y-m-d', strtotime("-{$retention_days} days"));
  \Drupal::database()->delete('page_analytics_daily')
    ->condition('stat_date', $cutoff, '<')
    ->execute();
}
